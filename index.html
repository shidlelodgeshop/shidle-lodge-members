<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDq5qdmtcbKiDC-US3_KZNTNK7abOuqLCs",
    authDomain: "shidle-lodge-members.firebaseapp.com",
    projectId: "shidle-lodge-members",
    storageBucket: "shidle-lodge-members.appspot.com",
    messagingSenderId: "293450171850",
    appId: "1:293450171850:web:c0ff81fe794f8eaf137b33"
  };
  firebase.initializeApp(firebaseConfig);

  const auth = firebase.auth();
  const db = firebase.firestore();
  let loginDenied = false;

  const normalizeEmail = (e) => (e || "").trim().toLowerCase();

  async function checkIfApproved(email) {
    const id = normalizeEmail(email);
    try {
      const doc = await db.collection("greenlist").doc(id).get();
      return doc.exists && doc.data()?.approved === true;
    } catch (err) {
      // If rules ever mis-configure, fail closed with a clear message
      console.error("Greenlist check failed:", err);
      throw new Error("Access check failed. Please try again or contact the Secretary.");
    }
  }

  async function signInWithEmail() {
    const rawEmail = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    const message = document.getElementById("loginMessage");
    message.textContent = "";

    try {
      const email = normalizeEmail(rawEmail);
      // Sign in first
      await auth.signInWithEmailAndPassword(email, password);

      // Then check approval
      const user = auth.currentUser;
      if (!user) throw new Error("Not signed in.");
      const approved = await checkIfApproved(user.email);

      if (!approved) {
        loginDenied = true;
        await auth.signOut();
        message.textContent = "Access denied. Contact the Lodge Secretary.";
        return;
      }
      window.location.href = "/home";
    } catch (error) {
      document.getElementById("loginMessage").textContent = error.message;
    }
  }

  async function signInWithGoogle() {
    const provider = new firebase.auth.GoogleAuthProvider();
    const message = document.getElementById("loginMessage");
    message.textContent = "";
    try {
      const result = await auth.signInWithPopup(provider);
      const user = result.user;
      if (!user) throw new Error("Google sign-in failed.");

      const approved = await checkIfApproved(user.email);
      if (!approved) {
        loginDenied = true;
        await auth.signOut();
        message.textContent = "Access denied. Contact the Lodge Secretary.";
        return;
      }
      window.location.href = "/home";
    } catch (error) {
      message.textContent = error.message;
    }
  }

  auth.onAuthStateChanged(async (user) => {
    if (user && !loginDenied) {
      try {
        const approved = await checkIfApproved(user.email);
        if (approved) {
          window.location.href = "/home";
        } else {
          await auth.signOut();
          document.getElementById("loginMessage").textContent =
            "Access denied. Contact the Lodge Secretary.";
        }
      } catch (e) {
        await auth.signOut();
        document.getElementById("loginMessage").textContent =
          e.message || "Access check failed. Please try again or contact the Secretary.";
      }
    }
  });
</script>
